# 安全運用ガイドライン

## 概要
このドキュメントは、6脚ロボットシステムの安全な運用方法を定義します。
事故（過電流・誤配線・暴走）を防ぎ、開発者・周囲の人・機体を保護することが目的です。

**対象**: システムの初見開発者から運用担当者まで、全員が理解すべき安全要件を記載します。

---

## 安全設計の基本方針

### 多層防御（Defense in Depth）

本システムは以下の多層的な安全機構を実装しています：

1. **ハードウェアレベル**: 電源分離、GND共通化、デカップリング
2. **ファームウェアレベル**: ARM/DISARM状態機械、デッドマンタイマー
3. **通信レベル**: BLE切断検出、即時停止
4. **運用レベル**: 初回通電手順、プリフライトチェック
5. **物理レベル**: サーボ固定、作業環境の安全確保

**原則**: いずれかの層が失敗しても、他の層で安全を確保する

---

## 1. ハードウェア安全要件

### 1.1 電源系統の分離（必須）

**要件**:
- サーボ電源とロジック電源（XIAO nRF52840）は**別系統**で供給
- 各系統に適切な容量の電源を使用

**理由**:
- サーボの大電流がロジック系に流れ込むと、MCUがリセット・BLE切断・誤動作
- 電源容量不足は電圧降下・発熱・火災の原因

**詳細**: `docs/wiring_pca9685.md` の「1. 電源系統の分離」を参照

### 1.2 GNDの共通化（必須）

**要件**:
- ロジック系GND、PCA9685 GND、サーボ電源GNDを**共通接続**
- スター配線を推奨（ノイズの回り込みを最小化）

**理由**:
- I2C通信・PWM信号の基準電位を揃えるため
- GNDが分離されていると、信号が正しく伝わらず誤動作

**詳細**: `docs/wiring_pca9685.md` の「2. GNDの共通化」を参照

### 1.3 電源容量の確保（必須）

**要件**:
- サーボ電源容量: （サーボ台数 × 1A）以上
- 例: 18サーボの場合、5V/10A以上または6V/8A以上

**理由**:
- 容量不足は電圧降下・サーボの異常動作・システムリセットの原因
- 複数サーボの同時動作時に最大電流が流れる

**詳細**: `docs/wiring_pca9685.md` の「5. 電源容量の計算」を参照

### 1.4 デカップリングコンデンサ（推奨）

**要件**:
- PCA9685のV+端子に1000μF～2200μF電解コンデンサを並列接続
- できるだけPCA9685基板の近くに配置

**理由**:
- サーボ起動時の突入電流を吸収
- 電源ノイズ・電圧降下を抑制
- I2C通信の安定化

**詳細**: `docs/wiring_pca9685.md` の「5.3 デカップリングコンデンサ」を参照

---

## 2. ファームウェア安全機構

### 2.1 ARM/DISARM状態機械

**動作**:
- 起動直後、BLE接続直後は**DISARMED状態**（サーボ動作不可）
- ユーザーが明示的に**ARMコマンド**を送信して初めてARMED状態へ遷移
- ARMED状態でのみサーボ制御コマンドが有効
- **DISARMコマンド**は常に受け付け、即座にサーボ停止

**状態遷移**:
```
[起動] → [DISARMED] ⇄ [ARMED]
              ↑           ↓
              └─ [FAULT] ─┘
```

**目的**:
- 誤操作・誤配線による暴走を防止
- 意図しない動作を排除

**詳細**: `docs/safety_implementation.md` の「2. 状態機械」を参照

### 2.2 デッドマンタイマー

**仕様**:
- ARMED状態で200ms以上コマンド受信がない場合、自動的にFAULT状態へ遷移
- PWM出力を即座に停止（パルス幅0）

**回避方法**:
- 定期的にPINGコマンドまたはサーボ制御コマンドを送信
- iOSアプリは自動的に周期送信（30～60Hz）

**目的**:
- BLE通信途絶・アプリクラッシュ時の暴走防止
- 操作者が意図せず離れた場合の安全停止

**詳細**: `docs/safety_implementation.md` の「4. デッドマンタイマ実装」を参照

### 2.3 BLE切断時の即時停止

**動作**:
- BLE切断イベント検出時、即座にFAULT状態へ遷移
- PWM出力を即座に停止（パルス幅0）
- デッドマンタイマー（200ms）を待たず、**即座に停止**

**目的**:
- 通信切断時の最速停止（遅延最小化）
- 意図しない切断（電波干渉・範囲外移動）への対応

**詳細**: `docs/safety_implementation.md` の「5. BLE切断時の即時停止」を参照

### 2.4 FAULT状態からの復帰

**手順**:
1. FAULT状態では、サーボ制御コマンドは無視される
2. **DISARMコマンド**を送信してDISARMED状態へ遷移
3. エラー原因を確認・解消
4. 再度**ARMコマンド**を送信

**理由**:
- FAULT状態から直接ARMを許可すると、エラー原因が未解決のまま動作再開される危険
- 明示的なDISARM経由を強制することで、操作者に状況確認を促す

---

## 3. 運用安全手順

### 3.1 初回通電手順（必須）

**目的**: 段階的な確認により、配線ミス・誤設定を早期発見

**手順**:

#### ステップ1: ロジック系のみ通電
- サーボ電源は**未接続**
- XIAOをUSBでPCに接続
- シリアルログでI2C初期化を確認

#### ステップ2: PCA9685に電源投入（サーボ未接続）
- サーボはまだ**未接続**
- サーボ電源をPCA9685に接続
- ログで "PCA9685 PWM device ready" を確認

#### ステップ3: サーボ1個を接続
- **1個だけ**サーボをチャンネル0に接続
- サーボが中心位置（1500μs）で保持されることを確認
- 異音・発熱がないか確認

#### ステップ4: BLEコマンドでサーボ制御
- BLEテストアプリで接続
- ARMコマンド送信 → サーボ制御コマンド送信
- サーボが指定位置へ動作することを確認

#### ステップ5: 複数サーボへ拡張
- 動作確認できたサーボから順次追加
- 各サーボの動作範囲を確認（キャリブレーション）

**詳細**: `docs/wiring_pca9685.md` の「6. 初回通電手順」を参照

### 3.2 プリフライトチェックリスト

**毎回の起動前に必ず確認**:

#### ハードウェア
- [ ] 配線に緩み・断線・短絡がない
- [ ] 電源電圧が規定範囲内（テスターで測定）
- [ ] サーボホーンが正しく取り付けられている
- [ ] 機体に破損・異常がない

#### ソフトウェア
- [ ] ファームウェアが最新版（または動作確認済みバージョン）
- [ ] iOSアプリが最新版（または動作確認済みバージョン）

#### 環境
- [ ] 作業台が安定している
- [ ] 周囲に障害物・人がいない
- [ ] 緊急時に電源を切れる状態

#### 動作確認
- [ ] BLE接続が成立する
- [ ] ARMコマンドが受け付けられる
- [ ] サーボが意図通りに動作する
- [ ] DISARMコマンドで即座に停止する

### 3.3 緊急停止手順

**状況**: サーボが暴走・異常動作している

**即座に実行**:
1. **iOSアプリでDISARMボタンを押す**（最優先）
2. それでも停止しない場合: **サーボ電源をOFF**
3. 原因調査のため、ログを保存

**やってはいけないこと**:
- 動いているサーボに手を出す（怪我の危険）
- 電源を入れたまま配線を抜く（破損の危険）

---

## 4. 危険シナリオと対策

### 4.1 過電流・火災リスク

**シナリオ**:
- 電源容量不足で配線・コネクタが発熱
- サーボのストール（負荷過大で停止）で大電流が流れ続ける

**対策**:
- 適切な容量の電源を使用（サーボ台数 × 1A以上）
- 配線に十分な太さの電線を使用（AWG22以上推奨）
- 異臭・発熱を感じたら即座に電源OFF

**検出方法**:
- 定期的に配線・コネクタの温度を確認
- バッテリー電圧監視（将来実装予定）

### 4.2 誤配線による破損

**シナリオ**:
- 電源極性を逆接続（GNDとV+を逆）
- サーボ電源をXIAOに直接接続
- I2C信号線の誤接続

**対策**:
- 配線前に配線図と実配線を再確認
- 電源投入前にテスターで電圧・極性を測定
- 初回通電は段階的に実施（ロジック系 → PCA9685 → サーボ）

**検出方法**:
- 電源投入時に異臭・発熱がないか確認
- ログでデバイス初期化を確認

### 4.3 BLE通信途絶による暴走

**シナリオ**:
- 電波干渉・範囲外移動でBLE切断
- iOSアプリのクラッシュ・フリーズ
- iPad/iPhoneのバッテリー切れ

**対策（ファームウェア）**:
- デッドマンタイマー（200ms）で自動停止
- BLE切断検出で即時停止

**対策（運用）**:
- 操作範囲を事前に確認（BLE到達距離: 10m程度）
- iPad/iPhoneのバッテリー残量を確認
- 電波干渉源（Wi-Fi、電子レンジ等）から離れる

### 4.4 ファームウェア・アプリのバグ

**シナリオ**:
- ARM/DISARMロジックのバグでサーボが意図せず動作
- デッドマンタイマーが機能しない

**対策（開発）**:
- 安全機能の単体テスト・統合テスト実施（`docs/safety_test.md`）
- コードレビューで安全機能を重点チェック

**対策（運用）**:
- 新バージョンのファームウェア・アプリは必ず卓上で動作確認
- サーボホーンを外した状態でテスト

---

## 5. 保守・点検

### 5.1 定期点検項目（推奨）

**頻度**: 10時間動作ごと、または1ヶ月ごと

**点検内容**:
- [ ] 配線の緩み・断線・被覆損傷
- [ ] コネクタの接触不良・腐食
- [ ] サーボの異音・発熱・ガタつき
- [ ] バッテリーの膨張・電圧低下
- [ ] PCA9685基板の異常（焦げ跡・破損）

### 5.2 消耗品の交換

**対象部品**:
- サーボモーター（異音・発熱・トルク低下が見られた場合）
- バッテリー（充電回数・電圧低下に応じて）
- 配線・コネクタ（破損・接触不良が見られた場合）

### 5.3 ログの保存

**推奨**:
- 異常動作・エラー発生時のシリアルログを保存
- Telemetryデータ（バッテリー電圧、エラーコード）を記録

**目的**:
- トラブルシューティング・再現性確認
- 将来の改善・バグ修正の参考資料

---

## 6. 教育・トレーニング

### 6.1 新規開発者へのオンボーディング

**必須ドキュメント**:
1. `README.md` - プロジェクト全体概要
2. `docs/wiring_pca9685.md` - 配線方法
3. **`docs/safety.md`（本ドキュメント）** - 安全運用
4. `docs/quick_start.md` - クイックスタートガイド

**実地トレーニング**:
- 初回通電手順の実施（ステップ1～5）
- 緊急停止手順の実演
- 配線チェックリストの確認

### 6.2 安全意識の共有

**原則**:
- **「動かない」が安全な状態** - 動作させるには明示的な操作が必要
- **疑わしい時は停止** - 異常を感じたら即座に電源OFF
- **段階的確認** - 一度に全部試さず、1つずつ確認

---

## 7. 関連ドキュメント

### 7.1 設計・実装
- `docs/safety_implementation.md` - 安全機能の実装詳細
- `docs/wiring_pca9685.md` - PCA9685配線ガイド
- `docs/servo_control.md` - サーボ制御仕様

### 7.2 テスト・検証
- `docs/safety_test.md` - 安全機能のテスト手順
- `docs/S1-08_acceptance_validation.md` - 受入テスト

### 7.3 プロトコル
- `shared/protocol/spec/legctrl_protocol.md` - BLEプロトコル仕様
- `docs/ble_protocol.md` - BLE詳細仕様

---

## 8. 責任と免責

### 8.1 開発者の責任

本システムの開発者・運用者は以下の責任を負います：

- 本ドキュメントおよび関連ドキュメントを熟読・理解する
- 配線・通電・運用時に安全手順を遵守する
- 異常を検知した場合、即座に停止し原因を調査する
- 新規開発者へ安全教育を実施する

### 8.2 免責事項

本システムはプロトタイプであり、以下を保証しません：

- 商用利用における安全性・信頼性
- あらゆる状況下での完全な安全性
- ハードウェア・配線の不備による事故の防止

**使用者は自己責任で本システムを使用してください。**

---

## 9. 改訂履歴

| Version | Date       | Author  | Changes                              |
|---------|------------|---------|--------------------------------------|
| v1.0    | 2026-01-03 | copilot | 初版作成（S1-09対応：安全運用ガイド） |

---

## 10. 緊急連絡先（チーム内で追記）

**トラブル発生時の連絡先**:
- プロジェクトリーダー: （TBD）
- ハードウェア担当: （TBD）
- ファームウェア担当: （TBD）

**報告事項**:
- 発生日時・状況
- 実施した対策
- 保存したログ・写真

---

**重要**: このドキュメントは生きたドキュメントです。新たな危険シナリオ・対策が見つかった場合、随時更新してください。
