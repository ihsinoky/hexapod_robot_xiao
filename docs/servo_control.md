# サーボ制御仕様

## 概要
このドキュメントでは、PCA9685を介したサーボモーター制御の仕様と安全な動作範囲を定義します。

---

## ハードウェア構成

### I2C接続
- **バス**: I2C1
- **SDA**: P0.04 (D4)
- **SCL**: P0.05 (D5)
- **クロック周波数**: 100kHz (標準モード)

### PCA9685設定
- **I2Cアドレス**: 0x40 (デフォルト)
- **チャンネル数**: 16ch (0-15)
- **PWM周波数**: 50Hz (20ms周期)

---

## PWM信号仕様

### 基本パラメータ
| パラメータ | 値 | 説明 |
|-----------|-----|------|
| PWM周波数 | 50Hz | 標準的なRCサーボ用 |
| 周期 | 20ms (20,000,000ns) | 1/50Hz |

### パルス幅範囲（標準180°サーボ）
| 位置 | パルス幅 | 角度 | 備考 |
|------|----------|------|------|
| 最小 | 1000μs (1,000,000ns) | 0° | 最小角度 |
| 中心 | 1500μs (1,500,000ns) | 90° | **安全な初期値** |
| 最大 | 2000μs (2,000,000ns) | 180° | 最大角度 |

> **注意**: サーボモーターの種類や機体構造により、安全な動作範囲は異なります。  
> 実機に合わせて調整してください。

---

## 初期化動作

### 起動時の安全動作
1. **PCA9685の初期化**
   - I2C通信確立
   - PWM周波数を50Hzに設定

2. **サーボチャンネル0の初期化**
   - パルス幅: **1500μs（中心位置）**
   - 理由: 急激な動作を防ぎ、機体への負荷を最小化

3. **動作確認**
   - ログ出力で設定値を確認
   - サーボが中心位置で保持されることを確認

### コード例（main.c）
```c
/* Safe initial value: 1500μs (center position) */
#define SERVO_PULSE_CENTER_NS  (1500000U)

ret = pwm_set(pwm_dev, SERVO_CHANNEL_0, 
              SERVO_PWM_PERIOD_NS, SERVO_PULSE_CENTER_NS, 
              PWM_POLARITY_NORMAL);
```

---

## 安全ガイドライン

### ✅ 推奨事項
- 起動時は必ず中心位置（1500μs）から開始
- 動作範囲の確認は、機体を支持した状態で実施
- パルス幅の変更は段階的に行う（急激な変化を避ける）
- 電源投入順序: サーボ電源 → XIAO起動

### ⚠️ 注意事項
- パルス幅範囲外（<1000μs, >2000μs）の設定は避ける
- 機体の物理的制約を考慮した動作範囲を設定
- 過負荷状態（サーボが動かない）を避ける

### 🚫 禁止事項
- 動作範囲未確認のまま最小/最大パルスを送信
- 電源容量を超えた複数サーボの同時駆動
- デバッグ用途以外でのBLE未接続時の動作（将来実装時）

---

## 調整手順（キャリブレーション）

### ステップ1: 中心位置の確認
1. ファームウェアを起動
2. サーボが1500μsで静止することを確認
3. 機体構造上の「中心」と一致するか確認

### ステップ2: 動作範囲の確認
1. パルス幅を段階的に変更（例: 1500 → 1400 → 1300 ...）
2. 機体が干渉しないか、サーボが無理をしていないか確認
3. 安全な最小値を記録

4. 同様に最大値側も確認（1500 → 1600 → 1700 ...）
5. 安全な最大値を記録

### ステップ3: パラメータの更新
確認した値を `main.c` またはコンフィグファイルに反映:
```c
#define SERVO_PULSE_MIN_NS     (1100000U)  /* 調整後の最小値 */
#define SERVO_PULSE_MAX_NS     (1900000U)  /* 調整後の最大値 */
```

---

## トラブルシューティング

### サーボが動かない
**確認項目**:
- [ ] PCA9685への電源供給（5-6V）
- [ ] I2C通信の確立（ログに "PCA9685 PWM device ready" が出力されるか）
- [ ] サーボへの配線（信号線、電源、GND）
- [ ] PWM出力の設定（ログに初期化メッセージがあるか）

### サーボが異常動作する
**原因と対策**:
- **振動・ジッタ**: 電源ノイズの可能性 → デカップリングコンデンサを追加
- **意図しない位置**: パルス幅設定ミス → ログで設定値を確認
- **過熱**: 負荷過大 → 動作範囲を制限、機体構造を確認

### I2C通信エラー
**確認項目**:
- [ ] SDA/SCLのプルアップ抵抗（2.2kΩ - 4.7kΩ）
- [ ] I2Cアドレスの設定（PCA9685: 0x40）
- [ ] 配線の長さ（短く保つ）
- [ ] クロック周波数の確認（100kHz推奨）

---

## 今後の拡張

### 複数チャンネル対応
- PCA9685は16chまで対応
- 一括更新機能の実装（I2Cトランザクション最適化）

### キャリブレーション機能
- チャンネルごとの中心/リミット設定
- 設定値の保存（NVS/Flash）

### BLE経由の制御
- ARM/DISARM機構の実装
- リアルタイムコマンド受信と安全停止

---

## 参照
- PCA9685データシート: [NXP PCA9685](https://www.nxp.com/docs/en/data-sheet/PCA9685.pdf)
- Zephyr PWM API: [PWM API Documentation](https://docs.zephyrproject.org/latest/hardware/peripherals/pwm.html)
- サーボモーター基礎: [Servo Motor Basics](https://www.servocity.com/how-servo-motors-work/)

---

## 改訂履歴

| Version | Date       | Author  | Changes                          |
|---------|------------|---------|----------------------------------|
| v1.0    | 2026-01-02 | copilot | 初版作成（S1-05対応）            |
