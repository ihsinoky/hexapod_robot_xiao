# PCA9685配線ガイド

## 概要
このドキュメントは、XIAO nRF52840とPCA9685サーボドライバの配線方法を詳述します。
**電源分離とGND共通化**を正しく理解し、安全な配線を実現することが目的です。

**対象**: ハードウェア初見の開発者が、このドキュメントのみで安全に配線・通電・確認できるレベルを目指します。

---

## システム構成

```
[iPad BLE App]
     |
    BLE
     |
     v
[XIAO nRF52840]  <-- USB電源（5V）またはバッテリー（3.7V Li-Po）
     |
    I2C (SDA/SCL) + 共通GND
     |
     v
[PCA9685]  <-- サーボ専用電源（4.8V～6V、十分な電流容量）
     |
    PWM (50Hz)
     |
     v
[サーボモーター x N]
```

---

## 1. 電源系統の分離（重要）

### 1.1 基本原則

| 系統 | 電源 | 供給先 | 電圧 | 電流容量 |
|------|------|--------|------|---------|
| **ロジック系** | USB/Li-Po | XIAO nRF52840 | 3.3V (内部) / 5V (USB) | ~100mA |
| **サーボ系** | 専用電源 | PCA9685 V+ → サーボ | 4.8V～6V | サーボ台数 × 1A以上 |

**⚠️ 絶対にやってはいけないこと**:
- XIAOの5VピンまたはUSB電源から直接サーボに電源供給（過電流で破損）
- サーボ電源をロジック側と共有（ノイズでMCUがリセット/誤動作）

### 1.2 なぜ電源を分離するのか？

**理由1: 電流容量**
- サーボモーター1個: 停止時50～200mA、動作時500mA～1A以上
- 複数サーボの同時駆動: 合計5A～10A以上の電流が必要
- XIAOのUSB電源やレギュレータは数百mA程度しか供給できない

**理由2: ノイズ分離**
- サーボモーターは起動時・負荷変動時に大電流が流れ、電源ラインにスパイクノイズを発生
- このノイズがロジック系に混入すると、MCUがリセット・BLE切断・誤動作を起こす
- 電源系統を分離することで、ノイズの影響を最小化

**理由3: 安全性**
- サーボ系の過電流・短絡が発生しても、ロジック系は影響を受けない
- デバッグ時にUSB接続のままサーボ動作テストが可能

---

## 2. GND（グラウンド）の共通化（重要）

### 2.1 基本原則

**✅ 必須**: ロジック系GNDとサーボ系GNDは**必ず共通接続**する

```
[XIAO GND] ━━━━━━━━━━━━━━━┓
                           ┃
[PCA9685 GND] ━━━━━━━━━━━━╋━━━ 共通GND（スター結線推奨）
                           ┃
[サーボ電源 GND] ━━━━━━━━━┛
```

### 2.2 なぜGNDを共通化するのか？

**理由1: I2C通信の基準電位**
- I2C信号（SDA/SCL）は電位差で通信する
- XIAO（送信側）とPCA9685（受信側）のGNDが異なると、信号が正しく読めない
- 通信エラー・誤動作の原因となる

**理由2: PWM信号の基準電位**
- PCA9685が出力するPWM信号もGNDを基準とする
- サーボがPWM信号を正しく受信するには、共通GNDが必須

**⚠️ 注意**: GND共通化は「電源を共有する」ことではない
- V+（電源のプラス側）は分離する
- GND（電源のマイナス側）のみ共通接続する

### 2.3 スター配線（推奨）

**配線方法**:
```
           ┌─── XIAO GND
           │
  [共通GND点] ─── PCA9685 GND
           │
           └─── サーボ電源 GND
```

**メリット**:
- サーボの大電流がロジック系のGNDラインに流れ込まない
- ノイズの回り込みを最小化
- トラブルシューティングが容易

**避けるべき配線（デイジーチェーン）**:
```
[XIAO GND] ─→ [PCA9685 GND] ─→ [サーボ電源 GND]  ❌
```
この配線では、サーボの大電流がXIAOのGNDラインを経由するためノイズが混入しやすい。

---

## 3. I2C配線（SDA/SCL）

### 3.1 XIAO nRF52840のI2Cピン配置

| 信号 | XIAOピン | Arduino名 | 物理位置 |
|------|----------|-----------|----------|
| SDA  | P0.04    | D4        | 右側下から4番目 |
| SCL  | P0.05    | D5        | 右側下から5番目 |
| GND  | GND      | GND       | 左側下から2番目 |
| 3V3  | 3V3      | 3V3       | 左側下から1番目 |

**ピン配置図**:
```
        XIAO nRF52840 (上から見た図)
        
 左側                      右側
  1  [3V3]           [D10/P1.03]  11
  2  [GND]           [D9 /P0.29]  10
  3  [D0 ]           [D8 /P1.13]   9
  4  [D1 ]           [D7 /P1.15]   8
  5  [D2 ]           [D6 /P1.11]   7
  6  [D3 ]           [D5 /P0.05] ← SCL
  7  [D4 /P0.04] ← SDA  [VBUS]  
```

### 3.2 PCA9685のI2C端子

| 端子 | 説明 |
|------|------|
| SDA  | I2Cデータ線（XIAOのSDAと接続） |
| SCL  | I2Cクロック線（XIAOのSCLと接続） |
| GND  | グラウンド（共通GNDと接続） |
| V+   | サーボ電源入力（4.8V～6V、ロジック電源とは別系統） |
| VCC  | ロジック電源入力（3.3V～5V、通常は3.3Vを接続） |

**注意**: PCA9685モジュールによってはVCCとV+が分離されていない場合があります。
基板上の回路を確認し、必要に応じて改造してください。

### 3.3 配線図

```
[XIAO nRF52840]          [PCA9685]
    SDA (D4)  ───────────── SDA
    SCL (D5)  ───────────── SCL
    GND       ───────────── GND  ┐
    3V3       ───────────── VCC  │  共通GND
                                 │
[サーボ電源]                     │
    +4.8V～6V ─────────────── V+  │
    GND       ───────────────────┘
```

### 3.4 プルアップ抵抗

**必須**: I2C信号線（SDA/SCL）には**プルアップ抵抗が必要**です。

**抵抗値**: 2.2kΩ ～ 4.7kΩ（推奨: 4.7kΩ）

**接続方法**:
```
    3V3 ─┬─[4.7kΩ]─── SDA
         │
         └─[4.7kΩ]─── SCL
```

**確認方法**:
- PCA9685モジュールに既にプルアップ抵抗が実装されている場合があります
- 基板上の抵抗（R1, R2等）や回路図を確認してください
- **もし実装されていない場合**: 外付けでプルアップ抵抗を追加する

**デバッグ**:
- I2C通信が不安定な場合、プルアップ抵抗値を変更（2.2kΩ ↔ 4.7kΩ）
- テスターでSDA/SCLの電圧を測定: 未接続時に3.3V付近であればOK

---

## 4. I2Cアドレス

### 4.1 デフォルトアドレス

**PCA9685のデフォルトI2Cアドレス**: `0x40` (7-bit)

**ファームウェアでの設定**:
```c
// firmware/zephyr/app/legctrl_fw/xiao_ble.overlay
pca9685: pca9685@40 {
    compatible = "nxp,pca9685-pwm";
    reg = <0x40>;  // I2Cアドレス
    status = "okay";
    #pwm-cells = <2>;
};
```

### 4.2 アドレス変更（複数PCA9685使用時）

PCA9685は最大62個まで同一バス上に接続可能（アドレス: 0x40～0x7F）

**アドレス設定方法**:
- PCA9685基板上のA0～A5ピンのジャンパー/抵抗で設定
- 例: A0をVCCに接続 → アドレス = 0x41

| A5 | A4 | A3 | A2 | A1 | A0 | アドレス |
|----|----|----|----|----|----|----|
| 0  | 0  | 0  | 0  | 0  | 0  | 0x40 |
| 0  | 0  | 0  | 0  | 0  | 1  | 0x41 |
| 0  | 0  | 0  | 0  | 1  | 0  | 0x42 |
| ... | ... | ... | ... | ... | ... | ... |

**詳細**: [PCA9685データシート](https://www.nxp.com/docs/en/data-sheet/PCA9685.pdf) のSection 7.1.6参照

---

## 5. 電源容量の計算

### 5.1 必要電流の見積もり

**サーボ1個あたりの消費電流**:
- 停止時（保持トルク）: 50～200mA
- 動作時（低負荷）: 300～500mA
- 動作時（高負荷/ストール）: 800mA～1.5A

**6脚ロボット（18サーボ）の例**:
- 最悪ケース（全サーボ同時動作・高負荷）: 18 × 1A = **18A**
- 典型的ケース（半数が動作・中負荷）: 9 × 0.5A + 9 × 0.1A = **5.4A**
- 最小ケース（全サーボ保持）: 18 × 0.1A = **1.8A**

### 5.2 推奨電源仕様

**最小要件**:
- 電圧: 4.8V～6V（5V推奨）
- 電流容量: サーボ台数 × 1A以上

**例**:
- 1～3サーボ: 5V/3A以上
- 4～8サーボ: 5V/5A以上
- 9～18サーボ: 5V/10A以上（または6V/8A以上）

**電源の種類**:
- Li-Poバッテリー（2S: 7.4V → 5V降圧レギュレータ経由）
- NiMHバッテリー（4～5セル: 4.8V～6V直接）
- ACアダプタ（卓上テスト用、5V/10A推奨）

### 5.3 デカップリングコンデンサ（推奨）

**目的**: 電源ラインのノイズ・電圧降下を抑制

**推奨値**:
- PCA9685の電源入力（V+）に**1000μF～2200μF電解コンデンサ**を並列接続
- できるだけ**PCA9685基板の近く**に配置

**接続方法**:
```
[サーボ電源+] ─┬─── V+ (PCA9685)
               │
            [1000μF]
               │
[サーボ電源-] ─┴─── GND (共通)
```

**効果**:
- サーボ起動時の突入電流を吸収
- 電源電圧の瞬間的な降下を抑制
- I2C通信の安定化

---

## 6. 初回通電手順（安全なBring-up）

### 6.1 事前準備

**確認項目**:
- [ ] 配線図とピン配置を再確認
- [ ] 電源電圧をテスターで測定（4.8V～6V範囲内か？）
- [ ] サーボホーン（回転軸の取り付け部）が外れている、または固定されている
- [ ] 作業台は安定しており、ロボットが暴走しても安全か？

**⚠️ 重要**: 初回通電時はサーボホーンを外すか、ロボット本体を支持してください。
予期しない動作で機体が破損・転倒する危険があります。

### 6.2 段階的通電手順

#### ステップ1: ロジック系のみ通電

1. **サーボ電源は接続しない**（V+を未接続）
2. XIAOをUSBケーブルでPCに接続
3. シリアルコンソールを開く（115200bps）
4. ログを確認:
   ```
   *** Booting Zephyr OS ... ***
   [00:00:00.123] INF: Starting LegCtrl Firmware
   [00:00:00.234] INF: I2C device ready
   [00:00:00.345] ERR: PCA9685 PWM device is not ready  ← 電源未接続なので正常
   ```

**期待動作**:
- XIAOが正常起動
- I2Cバスは初期化されるが、PCA9685は応答しない（電源未接続のため）

**NG例**:
- 起動しない → USB配線、XIAOの不良をチェック
- I2Cエラー以外のエラー → ファームウェアの問題

#### ステップ2: PCA9685に電源投入（サーボ未接続）

1. **サーボはまだ接続しない**
2. サーボ電源（4.8V～6V）のV+とGNDをPCA9685に接続
3. 電源をON
4. ログを確認:
   ```
   [00:00:01.123] INF: PCA9685 PWM device ready
   [00:00:01.234] INF: Setting initial servo position (1500us center)
   ```

**期待動作**:
- PCA9685が正常初期化
- ログに "PCA9685 PWM device ready" が出力される

**NG例**:
- "device is not ready" のまま → I2C配線、プルアップ抵抗、アドレスをチェック
- MCUがリセットする → GND共通化ができていない、電源ノイズをチェック

#### ステップ3: サーボ1個を接続

1. **1個だけ**サーボをPCA9685のチャンネル0に接続
2. サーボの配線:
   - 茶/黒（GND） → PCA9685のGND側（16ピンコネクタの下側）
   - 赤（V+） → PCA9685のV+側（16ピンコネクタの上側）
   - 橙/黄/白（信号） → チャンネル0の信号ピン
3. ログを確認:
   ```
   [00:00:02.123] INF: Servo output initialized at 1500us (center)
   ```

**期待動作**:
- サーボが中心位置（1500μs）で保持される
- 異音・発熱がない

**NG例**:
- サーボが振動・異音 → 電源電圧、配線極性をチェック
- サーボが動かない → PWM出力、配線をチェック

#### ステップ4: BLEコマンドでサーボ制御

1. BLEテストアプリ（nRF Connect等）で接続
2. ARMコマンドを送信（詳細は `docs/safety.md` 参照）
3. サーボ制御コマンドを送信（例: SET_SERVO_CH0）
4. サーボが指定位置へ動作することを確認

**期待動作**:
- ARMコマンド送信後、サーボ制御が可能
- DISARMコマンドでサーボが停止（パルス幅0）

**NG例**:
- ARM前にサーボが動く → ファームウェアの安全機能が無効（要確認）
- コマンドに応答しない → BLE通信、プロトコルをチェック

#### ステップ5: 複数サーボへ拡張

1. 動作確認できたサーボから順次追加
2. 各サーボの動作範囲を確認（キャリブレーション）
3. 全サーボ接続後、電源容量が十分か確認

**注意**:
- 一度に全サーボを接続しない（トラブル時の切り分けが困難）
- 電源容量を超えると電圧降下・リセットの原因となる

### 6.3 トラブルシューティング

| 症状 | 原因候補 | 対策 |
|------|---------|------|
| PCA9685が応答しない | I2C配線ミス、プルアップ抵抗不足 | 配線再確認、抵抗値変更 |
| サーボが振動する | 電源ノイズ、電圧不足 | デカップリングコンデンサ追加、電源容量UP |
| MCUがリセットする | GND未共通化、電源逆流 | GND配線確認、電源分離確認 |
| サーボが動かない | PWM設定ミス、配線極性ミス | ログ確認、配線極性確認 |

---

## 7. "ARMしないと動かない"運用（安全設計）

### 7.1 ARM/DISARM機構

**詳細**: `docs/safety.md` および `docs/safety_implementation.md` を参照

**概要**:
- 起動直後、BLE接続直後は**DISARMED状態**（サーボ動作不可）
- ユーザーが明示的に**ARMコマンド**を送信して初めてサーボ制御が可能
- **DISARMコマンド**で即座にサーボ停止

**目的**:
- 誤操作・誤配線による暴走を防止
- デバッグ時の安全性確保

### 7.2 デッドマン機能

**仕様**: コマンド受信がない状態が200ms続くと自動停止（FAULT状態へ遷移）

**目的**:
- BLE切断・通信途絶時の暴走防止
- 操作者が意図せず離れた場合の安全停止

**回避方法**:
- 定期的にPINGコマンドを送信（iOSアプリが自動送信）
- サーボ制御コマンド自体もデッドマンをリセット

### 7.3 BLE切断時の即時停止

**動作**:
- BLE切断イベント検出時、即座にFAULT状態へ遷移
- PWM出力を停止（パルス幅0）

**重要**: デッドマンタイマー（200ms）を待たず、**即座に停止**

---

## 8. 配線チェックリスト

配線完了後、以下をチェックしてください：

### 8.1 電源系統
- [ ] サーボ電源とロジック電源は**分離**されている
- [ ] サーボ電源の電圧は4.8V～6V範囲内
- [ ] サーボ電源の容量は（サーボ台数 × 1A）以上
- [ ] XIAOへの電源供給はUSBまたはLi-Po（サーボ電源とは別）
- [ ] デカップリングコンデンサ（1000μF程度）をPCA9685のV+に接続

### 8.2 GND系統
- [ ] XIAO GND、PCA9685 GND、サーボ電源GNDが**共通接続**されている
- [ ] GND配線はスター配線（推奨）またはノイズ対策済み

### 8.3 I2C配線
- [ ] XIAO SDA (D4) ↔ PCA9685 SDA
- [ ] XIAO SCL (D5) ↔ PCA9685 SCL
- [ ] プルアップ抵抗（4.7kΩ推奨）が存在する

### 8.4 サーボ配線
- [ ] 各サーボの極性が正しい（GND/V+/信号の順序）
- [ ] サーボコネクタがしっかり挿入されている
- [ ] サーボホーンが外れている、または固定されている（初回通電時）

### 8.5 安全確認
- [ ] 配線図と実配線が一致している
- [ ] 短絡・接触不良がないか目視確認
- [ ] 電源投入前に電圧をテスターで測定
- [ ] 初回通電はロジック系のみから開始

---

## 9. 参考資料

### 9.1 関連ドキュメント
- `docs/servo_control.md` - サーボ制御仕様（PWMパラメータ、キャリブレーション）
- `docs/safety.md` - 安全運用ガイドライン（ARM/DISARM、緊急停止）
- `docs/safety_implementation.md` - 安全機能の実装詳細
- `README.md` - プロジェクト全体概要

### 9.2 データシート・外部資料
- [PCA9685データシート (NXP)](https://www.nxp.com/docs/en/data-sheet/PCA9685.pdf)
- [XIAO nRF52840仕様 (Seeed Studio)](https://wiki.seeedstudio.com/XIAO_BLE/)
- [Zephyr I2C API](https://docs.zephyrproject.org/latest/hardware/peripherals/i2c.html)
- [Zephyr PWM API](https://docs.zephyrproject.org/latest/hardware/peripherals/pwm.html)

### 9.3 ファームウェア実装
- `firmware/zephyr/app/legctrl_fw/xiao_ble.overlay` - I2C/PCA9685のDevice Tree設定
- `firmware/zephyr/app/legctrl_fw/prj.conf` - I2C/PWMドライバの有効化
- `firmware/zephyr/app/legctrl_fw/src/main.c` - PCA9685初期化コード

---

## 改訂履歴

| Version | Date       | Author  | Changes                                    |
|---------|------------|---------|--------------------------------------------|
| v1.0    | 2026-01-03 | copilot | 初版作成（S1-09対応：配線・電源・安全注意） |
